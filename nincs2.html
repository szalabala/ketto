<!DOCTYPE html>
<html>
<head>
  <title>Kincs, ami nincs</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="viewport" content="minimal-ui,width=device-width, initial-scale=1">
  <meta charset="UTF-8">
<style>
.debug { display:none }
html, body {
  height:100%;
  width:100%;
  padding:0;
  margin:0;
  height: -webkit-fill-available;
  width: -webkit-fill-available;
}
h2 { font-size:5vmin; } 
.xl { font-size:10vmin }
.big { font-size:5vmin }
.medium { font-size:4vmin }
.small { font-size:3vmin }
.icon { height:13vmin;width:13vmin;max-height:15vh;max-width:15vw; }
.bigicon { height:20vmin;width:20vmin;max-height:25vh;max-width:25vw; }
.rotate { transition: transform 2s linear; }  
p { margin:auto; padding:0;font-size:3vmin; border-radius:25%; }
body { background-image:url("images/csempe.jpg"); overflow: hidden; }
table, tr, td { border: none; padding:0; margin:0; text-align: center; }
img.mozgo { position: absolute; left: 0px; top: 0px; display:inline-block;}
img.top { z-index: 3; }
img.back { z-index: 1; }
@keyframes blink1{
  0%{ transform: scale(1,1); }
  10%{ transform: scale(1.05,1.05); }
  20%{ transform: scale(1,1); }
  30%{ transform: scale(1.05,1.05); }
  40%{ transform: scale(1,1); }
  100%{ transform: scale(1,1); }
}
@keyframes blink2{
  0%{ transform: scale(1,1); }
  10%{ transform: scale(1.2,1.2); }
  20%{ transform: scale(1,1); }
}
</style>
<script>
    var _name = "Nincs Kettő Négy Nélkül";
    var _version = '0.9.7';
    var _fps = 10;
    var _shortMs = 500;
    var _longMs = 1500;
    var gameDesc = { maxPair: 12
        , H: 3
        , W: 6
        , dice: 4
        , start_message: "<span style=\"color:blue;text-decoration:blink;\">" + "lovas" + "</span>"
        , restart_message: "<span style=\"color:blue;text-decoration:blink;\">Kattints a Puffinra az újrakezdéshez</span>"
        , tabla: "kincsaminincs-terkep1000d.jpg", tabla0: "images/nincs2header_46.jpg", tabla_end: "ending.jpg"
        , music: "audio/movin-cruisin-xylo.mp3", music0: "audio/movin-crusin-cover1.mp3"
        , figure_scale: 15 // % of table-height, cc 15vh
        , figures: [
            { name: "Charlie", step: 0, kincs: false, imgsrc: "fig1c.png", img2src: "fig1d.png", img2step: 19 },
            { name: "Alan", step: 0, kincs: false, imgsrc: "fig2c.png", img2src: "fig2d.png", img2step: 19 },
            { name: "Frisco", step: 0, kincs: false, imgsrc: "fig4c.png", img2src: "fig4.png", img2step: 44 },
            { name: "Kalóz", step: 0, kincs: false, imgsrc: "fig5c.png", img2src: "fig5.png", img2step: 32 }
        ]
    };
    var gameData = {
        steps: [], turn: 0, aktiv: 0, players: [], started: false, pics: [],
        targetList: [],  // { id, img_src, posid }
        total: 0,
        found: 0,
        attempts: 0
    };
    var gameUI = {
        mainAreaWidthPc: 80, mainAreaHeightPc: 90, // figureSizePc: 10,
        fullscr: 0, muted: false,
        cache: { imgSizePx: 100, offsetXPx:1, offsetYPx:1 }
    };

    function myLoad() {
        const queryString = window.location.search;
        if (queryString != '') {
            console.log(queryString);

            const urlParams = new URLSearchParams(queryString);
            if (urlParams.has('frameMs')) {
                frameMs = parseInt(urlParams.get('frameMs'))
            }
        }
    }

    function start() {
        document.getElementById('tabla').src = gameDesc.tabla0;

        setTimeout(myResize, 10);  // initial placement

        for (var i=1;i < 2; i++ ) { // whatever
            //document.getElementById('p'+i).style.filter = 'invert(0%)';
            if (!(new URLSearchParams(window.location.search)).has('start')) {
                setTimeout(myBlink, 5 + i*200, "p"+i);
            }
        }
        myLoad();
        restartGame();
    }

    function restartGame() {
        gameData.targetList = [];  // creating a random list of number, the pictures to show
        var N = gameDesc.W * gameDesc.H;   //number of pairs to match
        var N2 = Math.floor(N / 2 );   //number of pairs to match
        var list = [];  // creating a random list of number, the pictures to show
        var poslist = [];

        for (var i = 1; i <= gameDesc.maxPair; i++) { // random list of pairs
            list.push(i);
        }
        shuffle(list);

        for (var i = 0; i < N; i++) { // random list of positions
            poslist.push(i);
        }
        shuffle(poslist);
        
        console.log(`start ${list} x ${poslist}`);
        for (var i = 0; i < N2; i++) {  // add tiles
            gameData.targetList.push( { id: `p${1+2*i}`, src: `images/${list[i]}a.jpg`, posid: poslist[i*2] } ); 
            gameData.targetList.push( { id: `p${2+2*i}`, src: `images/${list[i]}b.jpg`, posid: poslist[i*2+1] } ); 
        }
        
        for (var i = 0; i < N; i++) {
            addImage(gameData.targetList[i].id, gameData.targetList[i].src);
        }
        setTimeout(myResize, 10);  // initial placement
    }

    function getPosPcOf(posId) { // return { xpc, ypc }s
        console.log(`  posid ${posId} -> ${Math.floor(posId % gameDesc.W)}:${Math.floor(posId / gameDesc.W)}`);
        return {
            x_pc: Math.floor( ((100 - gameUI.mainAreaWidthPc) / 2) + ((posId % gameDesc.W) * (gameUI.mainAreaWidthPc) / (gameDesc.W -1))),
            y_pc: Math.floor( ((100 - gameUI.mainAreaHeightPc) / 2) + (Math.floor(posId / gameDesc.W) * (gameUI.mainAreaHeightPc / (gameDesc.H - 1))))
        };
    }

    function getPosPxOfPospc( pos_pc ) {  // { xpc, ypc }
        var cw = document.documentElement.clientWidth;
        var ch = document.documentElement.clientHeight;

        console.log(`  pospc .. ${pos_pc.x_pc} ${pos_pc.y_pc}`);

        return {
            x: Math.floor((cw - gameUI.cache.imgSizePx) * pos_pc.x_pc / 100),  // + gameUI.OffsetXPx
            y: Math.floor((ch - gameUI.cache.imgSizePx) * pos_pc.y_pc / 100)   // + gameUI.OffsetYPx
        };
    }

    function addImage(id,isrc) {
        console.log(` add ${id} of ${isrc}`);
        var img = document.createElement('img'); 
        img.id = id;
        img.src = isrc;
        img.classList.add("mozgo");
        img.classList.add("top");
        img.style.borderRadius = "25%";
        document.getElementById('toptable').appendChild(img);
    }

    function myResize() {
        console.log(`resize`);
        var cw = document.documentElement.clientWidth;
        var ch = document.documentElement.clientHeight;
        var iw = window.innerWidth;

        var isAndroid = /(android)/i.test(navigator.userAgent);
        if (isAndroid) {
            document.getElementById('toptable').style.width = cw + 'px';
        } else {
            document.getElementById('toptable').style.width = iw + 'px';
        }

        var dh = document.getElementById('tabla').offsetHeight;
        var r0 = document.getElementById('tabla').naturalWidth / document.getElementById('tabla').naturalHeight;
        var r = document.getElementById('tabla').offsetWidth / document.getElementById('tabla').offsetHeight;
        var tw = Math.floor(cw * gameUI.mainAreaWidthPercent / 100);
        var th = Math.floor(ch * gameUI.mainAreaHeightPercent / 100);
        var th0= Math.floor(tw / r0);

        //var img_w = Math.floor( (cw * 80) / gameDesc.W / 100 );
        var img_maxw = Math.floor((cw * gameUI.mainAreaWidthPc / 100) / gameDesc.W);
        var img_maxh = Math.floor((ch * gameUI.mainAreaHeightPc / 100) / gameDesc.H);
        gameUI.cache.imgSizePx = Math.floor( (cw * gameUI.mainAreaWidthPc / 100) / gameDesc.W );
        gameUI.cache.offsetXPx = Math.floor( (cw * (100-gameUI.mainAreaWidthPc) / 100) / 2 );
        gameUI.cache.offsetYPx = Math.floor( (ch * (100-gameUI.mainAreaHeightPc) / 100) / 2 );

        var N = gameDesc.W * gameDesc.H;   //number of images to match
        for (var i = 0; i < gameData.targetList.length; i++) {
            console.log(` r ${i} ${gameData.targetList[i].id}`)
            var pos = getPosPxOfPospc(getPosPcOf(gameData.targetList[i].posid));
            var img = document.getElementById(gameData.targetList[i].id);
            img.style.maxWidth = gameUI.cache.imgSizePx + 'px';
            img.style.maxHeight = gameUI.cache.imgSizePx + 'px';
            img.style.left =  pos.x + "px"; // + gameUI.cache.offsetXPx 
            img.style.top = pos.y + "px"; // + gameUI.cache.offsetYPx 
            console.log(`  res ${i} ${gameData.targetList[i].id} ${img.style.left} ${img.style.top}` );
        }
    }
    function setStyle(elem,styleitem,value) {
        //document.getElementById(elem).style.setProperty(styleitem,value)
    }
    function getPPosX(step,player=0) {
        return gameDesc.steps[step].x;
    }
    function getPPosY(playeridx=0) {
        return gameDesc.steps[players[gameData.players[playeridx]].step].y + (players[gameData.players[playeridx]].step==0 ? playeridx*15 : 0);
    }
    function myBlink(imgId,isSet=1) {
        document.getElementById(imgId).style.animation="blink1 2s infinite";
        document.getElementById(imgId).style.tranform="none";
    }

    function toggleFullScr() {
        console.log(`full ${gameUI.fullscr}`)
        if (gameUI.fullscr == 0) {
            if ( document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if ( document.documentElement.webkitrequestFullscreen) {
                document.documentElement.webkitrequestFullscreen();
            } else if ( document.documentElement.mozrequestFullscreen) {
                document.documentElement.mozrequestFullscreen();
            } else if ( document.documentElement.msrequestFullscreen) {
                document.documentElement.msrequestFullscreen();
            }
            gameUI.fullscr = 1;
        } else {
            if ( document.documentElement.exitFullscreen) {
                document.documentElement.exitFullscreen();
            } else if ( document.documentElement.cancelFullscreen) {
                document.documentElement.cancelFullscreen();
            } else if ( document.documentElement.webkitexitFullscreen) {
                document.documentElement.webkitexitFullscreen();
            } else if ( document.documentElement.mozexitFullscreen) {
                document.documentElement.mozexitFullscreen();
            } else if ( document.documentElement.msexitFullscreen) {
                document.documentElement.msexitFullscreen();
            } else {
                alert('exit fullscreen, doesnt work');
            }
            gameUI.fullscr = 0;    
        }
        myResize();
        //setTimeout(function(){window.scrollTo(0, 0); }, 5);
    }

    function toggleAudio() {
      console.log(`mute:${gameUI.muted}`);
      if (gameUI.muted == false) {
            gameUI.muted = true;
            document.getElementById('myaudio').pause();
      } else {
            gameUI.muted = false;
            document.getElementById('myaudio').play();
      }
    }

    function debugPos(dx,dy,player=0) {
      idx=players[player].step
      gameDesc.steps[idx].x+=dx;
      gameDesc.steps[idx].y+=dy;
      movePlayerImg(player,idx);
      document.getElementById('mytext').innerHTML=`x:${gameDesc.steps[idx].x}, y:${gameDesc.steps[idx].y}`;
    }

    function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
    }
/*width:10%;height:10%;padding:0;display:inline-block;
display:inline-block;
*/
</script>
</head>
<body onload="start();" onresize="myResize();">
    <audio id="myaudio" src="audio/movin-cruisin-xylo.mp3" autoplay loop> </audio>
    <div id="toptable" style="position:absolute;width:100%;height:100%;padding:0;">

        <img id="tabla" class="back" src="images/kincsaminincs-terkep800.jpg" style="position:absolute;float:left;left:0;padding:0;text-align:center;vertical-align:top;max-height:99vh;max-width:99vw;z-index:-1;">
        <p id="mytext" class="medium" style="position:absolute;float:left;left:20%;top:80%;width:60%;height:20%;padding:0;text-align:left;font-stretch:semi-condensed;">some text</p>

        <div style="position:absolute;float:left;height:45%;top:30%;width:20%;">
            <!-- left:5%; -->
            <button id="kocka" onclick="kockadobas();" disabled=true>
                <img id="dice" class="rotate" src="image/dice.png" style="max-height:35vmin;max-width:90%;">
            </button>
        </div>

        <div style="position:relative;float:right;width:90%;text-align:right;vertical-align:top;">
            <p style="text-align:right"><img src="images/volume.png" style="max-height:4vmin" onclick="toggleAudio()"><img src="images/fullscr.png" style="max-height:5vmin" onclick="toggleFullScr()"></p>
        </div>
        <p style="position:fixed;float:right;width:90%;text-align:right;bottom:0%;right:0%;"><i>&copy; Copyright 2021 szalabala - grafika: TBD</i></p>
    </div>
    <!--
        <div style="position:absolute;float:left;max-height:15%;max-width:75%;text-align:center;top:50%;left:10%;transform-origin:bottom left;transform:rotate(-90deg);">
            <h2>Nincs kettő négy nélkül</h2>
        </div>
    -->
</body>
    </html>
